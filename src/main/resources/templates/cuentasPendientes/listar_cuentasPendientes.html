<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/header :: header(title = 'Cuentas pendientes')">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuentas pendientes</title>
</head>

<body>
    <div id="wrapper">
        <div th:replace="fragments/sidebar :: sidebar"></div>

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <div class="container-fluid p-4">
                    <div
                        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Listado de Cuentas pendientes</h1>
                    </div>

                    <a th:href="@{/cuentasPendientes/nueva}" class="btn btn-primary mb-3">Nueva cuenta</a>

                    <!-- Mensaje Flash -->
                    <div th:if="${mensaje}"
                        th:classappend="${tipoMensaje == 'success' ? 'alert alert-success' : 'alert alert-danger'}"
                        class="alert alert-dismissible fade show" role="alert">
                        <span th:text="${mensaje}"></span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped" width="100%" cellspacing="0" id="dataTable">
                            <thead>
                                <tr>
                                    <th>Ultima fecha de pago</th>
                                    <th>Cliente</th>
                                    <th>Servicio</th>
                                    <th>Monto total</th>
                                    <th>Monto pagado</th>
                                    <th>Saldo pendiente</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="cup : ${cuentasPendientes}">
                                    <td th:text="${cup.ultimaFechaPago}">ultimaFechaPago</td>
                                    <td th:text="${cup.idCliente.nombres}">cliente</td>
                                    <td th:text="${cup.idServicio.nombreServicio}">servicio</td>
                                    <td th:text="'$' + ${cup.montoTotal}">montoTotal</td>
                                    <td th:text="'$' + ${cup.montoPagado}">montoPagado</td>
                                    <td th:text="'$' + ${cup.saldoPendiente}">saldoPendiente</td>
                                    <td th:text="${cup.estado}">estado</td>
                                    <td>
                                        <button th:if="${cup.estado != 'Liquidado'}" type="button" class="btn btn-link p-0 btn-editar"
                                            th:data-id="${cup.idCuenta}" th:data-fecha="${cup.ultimaFechaPago}"
                                            th:data-montototal="${cup.montoTotal}"
                                            th:data-montopagado="${cup.montoPagado}">
                                            <i class="fas fa-edit" style="color: #085691;"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(cuentasPendientes)}">
                                    <td colspan="6" class="text-center">No hay cuentas pendientes registradas.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarLabel">Editar cuenta pendiente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/cuentasPendientes/editar}" method="post">
                    <div class="modal-body">
                        <input type="hidden" id="idCuenta" name="idCuenta">

                        <div class="mb-3">
                            <label for="ultimaFechaPago" class="form-label">Ãšltima Fecha de Pago</label>
                            <input type="text" class="form-control" id="ultimaFechaPago" name="ultimaFechaPago"
                                readonly>
                        </div>

                        <div class="mb-3">
                            <label for="montoTotal" class="form-label">Monto Total</label>
                            <input type="text" class="form-control" id="montoTotal" name="montoTotal" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="montoPagado" class="form-label">Monto Pagado</label>
                            <input type="text" class="form-control" id="montoPagado" name="montoPagado" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="abono" class="form-label">Abono</label>
                            <input type="number" step="0.01" class="form-control" id="abono" name="abono" required
                                min="0.01">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div th:replace="fragments/jsComponents :: jsScripts"></div>
    <script>
        function cerrarModal() {
            const modalElement = document.getElementById('modalEditar');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const botonesEditar = document.querySelectorAll('.btn-editar');

            botonesEditar.forEach(boton => {
                boton.addEventListener('click', function () {
                    const idCuenta = this.getAttribute('data-id');
                    const fecha = this.getAttribute('data-fecha');
                    const montoTotal = this.getAttribute('data-montototal');
                    const montoPagado = this.getAttribute('data-montopagado');

                    abrirModalEditar(idCuenta, fecha, montoTotal, montoPagado);
                });
            });
        });

        function abrirModalEditar(idCuenta, ultimaFechaPago, montoTotal, montoPagado) {
            const saldoPendiente = parseFloat(montoTotal) - parseFloat(montoPagado);

            document.getElementById('idCuenta').value = idCuenta;
            document.getElementById('ultimaFechaPago').value = ultimaFechaPago;
            document.getElementById('montoTotal').value = "$" + montoTotal;
            document.getElementById('montoPagado').value = "$" + montoPagado;

            document.getElementById('abono').value = '';
            document.getElementById('abono').focus();

            const modalElement = document.getElementById('modalEditar');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    </script>
</body>

</html>
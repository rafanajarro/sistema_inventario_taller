<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/header :: header(title='Usuarios')"></head>

<body>
<div id="wrapper">
    <!-- Sidebar -->
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <!-- Contenido principal -->
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <div class="container-fluid p-4">

                <!-- Encabezado dinámico -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" th:text="${usuario.idUsuario} != null ? 'Editar Usuario' : 'Crear Usuario'"></h1>
                </div>

                <!-- Mensajes flash -->
                <div th:if="${mensaje}"
                     th:classappend="${tipoMensaje == 'success' ? 'alert alert-success' : 'alert alert-danger'}"
                     class="alert alert-dismissible fade show" role="alert">
                    <span th:text="${mensaje}"></span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Formulario Usuario -->
                <form th:action="${usuario.idUsuario} != null ? @{/usuarios/actualizar} : @{/usuarios/guardar}"
                      th:object="${usuario}" method="post" class="needs-validation" novalidate>

                    <input type="hidden" th:field="*{idUsuario}"/>

                    <!-- Nombres -->
                    <div class="form-group mb-3">
                        <label for="nombres" class="form-label">Nombres</label>
                        <input type="text" th:field="*{nombres}" class="form-control" id="nombres" required>
                        <div class="invalid-feedback">Los nombres son obligatorios</div>
                    </div>

                    <!-- Apellidos -->
                    <div class="form-group mb-3">
                        <label for="apellidos" class="form-label">Apellidos</label>
                        <input type="text" th:field="*{apellidos}" class="form-control" id="apellidos" required>
                        <div class="invalid-feedback">Los apellidos son obligatorios</div>
                    </div>

                    <!-- Username -->
                    <div class="form-group mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" th:field="*{username}" class="form-control" id="username" required>
                        <div class="invalid-feedback">El username es obligatorio</div>
                    </div>

                    <!-- DUI -->
                    <div class="form-group mb-3">
                        <label for="dui" class="form-label">DUI</label>
                        <input type="text"
                               th:field="*{dui}"
                               class="form-control"
                               id="dui"
                               placeholder="00000000-0"
                               required
                               pattern="[0-9]{8}-[0-9]{1}">
                        <div class="invalid-feedback">Debe ingresar un DUI válido (ejemplo: 12345678-9)</div>
                    </div>

                    <!-- Teléfono -->
                    <div class="form-group mb-3">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input type="tel"
                               th:field="*{telefono}"
                               class="form-control"
                               id="telefono"
                               placeholder="0000-0000"
                               pattern="[0-9]{4}-[0-9]{4}"
                               required>
                        <div class="form-text">Formato: ####-####</div>
                        <div class="invalid-feedback">Debe ingresar un teléfono válido (ej: 7777-1234)</div>
                    </div>

                    <!-- Correo -->
                    <div class="form-group mb-3">
                        <label for="correo" class="form-label">Correo</label>
                        <input type="email" th:field="*{correo}" class="form-control" id="correo" required>
                        <div class="invalid-feedback">Debe ingresar un correo válido</div>
                    </div>

                    <!-- Contraseña -->
                    <div class="form-group mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <input type="password" th:field="*{password}" class="form-control" id="password"
                               th:attr="placeholder=${usuario.idUsuario} != null ? 'Dejar en blanco si no desea cambiar' : ''"
                               th:required="${usuario.idUsuario == null}">
                    </div>

                    <!-- Rol -->
                    <div class="form-group mb-3">
                        <label for="rol" class="form-label">Rol</label>
                        <select th:field="*{idRol.idRol}" class="form-select" id="rol" required>
                            <option value="" disabled th:selected="${usuario.idRol == null}">Seleccione un rol</option>
                            <option th:each="rol : ${roles}"
                                    th:value="${rol.idRol}"
                                    th:text="${rol.descripcion}"
                                    th:selected="${usuario.idRol != null} ? ${rol.idRol} == ${usuario.idRol.idRol} : false">
                            </option>
                        </select>
                    </div>

                    <!-- Estado -->
                    <div class="form-group mb-3">
                        <label for="estado" class="form-label">Estado</label>
                        <select th:field="*{estado}" class="form-control" id="estado" required>
                            <option value="A" th:selected="${usuario.estado == 'A'}">Activo</option>
                            <option value="I" th:selected="${usuario.estado == 'I'}">Inactivo</option>
                        </select>
                    </div>

                    <!-- Botones -->
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                    <a href="/usuarios" class="btn btn-secondary">
                        <i class="bi bi-arrow-left-circle"></i> Cancelar
                    </a>
                </form>

            </div>
        </div>
    </div>
</div>

<div th:replace="fragments/jsComponents :: jsScripts"></div>

<!-- Validación de Bootstrap -->
<script>
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>
</body>
</html>
